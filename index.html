<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main: #0071e3; --bg: #f5f5f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 200px; user-select: none; }
        .header { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; position: sticky; top: 0; z-index: 10; }
        .product-list { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .product { background: white; border-radius: 15px; padding: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .product img { width: 100%; height: 120px; object-fit: contain; }
        .btn-add { background: var(--main); color: white; border: none; width: 100%; padding: 10px; border-radius: 10px; margin-top: 10px; font-weight: 600; }
        .cart-panel { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; border-top: 1px solid #ddd; display: none; box-sizing: border-box; }
        .input-field { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn-order { background: #34c759; color: white; border: none; width: 100%; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; width: 100%; }
    </style>
</head>
<body>
    <div class="header"> iShop</div>
    <div id="list" class="product-list"></div>

    <div id="cart" class="cart-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><b>Итого:</b><b id="total">0 ₽</b></div>
        <input type="text" id="name" class="input-field" placeholder="Ваше имя">
        <input type="text" id="username" class="input-field" placeholder="Ваш @username в Telegram">
        <button class="btn-order" id="order-btn" onclick="send()">Заказать (0)</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let cart = {};

        async function load() {
            const r = await fetch("https://my-bot-frizzby.amvera.io/api/products");
            const products = await r.json();
            const list = document.getElementById('list');
            products.forEach((p, i) => {
                list.innerHTML += `<div class="product">
                    <img src="${p.photo}">
                    <h3>${p.name}</h3>
                    <p>${p.price} ₽</p>
                    <button class="btn-add" onclick="add(${i},'${p.name}',${p.price})">В корзину</button>
                </div>`;
            });
        }

        function add(id, name, price) {
            if (!cart[id]) cart[id] = { name, price, count: 0 };
            cart[id].count++;
            update();
        }

        function update() {
            let total = 0, count = 0;
            for (let k in cart) { total += cart[k].price * cart[k].count; count += cart[k].count; }
            document.getElementById('cart').style.display = count > 0 ? 'block' : 'none';
            document.getElementById('total').innerText = total + ' ₽';
            document.getElementById('order-btn').innerText = `Заказать (${count})`;
        }

        function send() {
            const n = document.getElementById('name').value.trim();
            const u = document.getElementById('username').value.trim();
            if (!n || !u) return alert("Заполните Имя и Username!");

            tg.sendData(JSON.stringify({
                products: Object.values(cart).map(i => `${i.name} x${i.count}`).join(", "),
                total: document.getElementById('total').innerText,
                customer_name: n,
                customer_username: u
            }));
            tg.close();
        }
        load();
    </script>
</body>
</html>